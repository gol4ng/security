package jwt

import (
	"encoding/base64"
	"errors"

	"github.com/dgrijalva/jwt-go"
	"github.com/gol4ng/security"
	"github.com/gol4ng/security/user"
)

var ErrAuthenticationFailed = errors.New("authentication failed")

type Authenticator struct {
	parser         Parser
	usernameGetter UsernameGetter
}

func (a Authenticator) Authenticate(t security.Token) (security.Token, error) {
	var token *Token
	rawToken, ok := t.(*RawToken)
	if !ok {
		return t, errors.New("token type not supported")
	}

	decodedToken, err := base64.StdEncoding.DecodeString(rawToken.GetRaw())
	if err != nil {
		return t, err
	}

	jwtToken, err := a.parser.Parse(string(decodedToken))
	token = NewToken(jwtToken)
	if err != nil {
		return token, err
	}

	if !jwtToken.Valid {
		return token, ErrAuthenticationFailed
	}

	username := a.usernameGetter(jwtToken.Claims)
	if username == "" {
		return token, errors.New("username not found")
	}

	token.SetUser(user.NewUser(username))
	token.SetAuthenticated(true)

	return token, nil
}

func (a *Authenticator) Support(t security.Token) bool {
	_, support := t.(*RawToken)
	return support
}

func (a *Authenticator) apply(options ...AuthenticatorOption) *Authenticator {
	for _, option := range options {
		option(a)
	}
	return a
}

// AuthOption defines a interceptor middleware configuration option
type AuthenticatorOption func(*Authenticator)

func NewAuthenticator(parser Parser, options ...AuthenticatorOption) *Authenticator {
	return (&Authenticator{
		parser:         parser,
		usernameGetter: DefaultUsernameGetter,
	}).apply(options...)
}

func WithUsernameGetter(getter UsernameGetter) AuthenticatorOption {
	return func(authenticator *Authenticator) {
		authenticator.usernameGetter = getter
	}
}

type UsernameGetter func(claims jwt.Claims) string

func DefaultUsernameGetter(claims jwt.Claims) string {
	mapClaims, ok := claims.(jwt.MapClaims)
	if !ok {
		return ""
	}
	sub, ok := mapClaims["sub"]
	if !ok {
		return ""
	}

	s, ok := sub.(string)
	if !ok {
		return ""
	}

	return s
}
